<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title></title>
</head>

<body>
  <canvas id="canvas" width="300" height="300"></canvas>
  <script>
    var canvas = document.getElementsByTagName("canvas")[0]
    var ctx = canvas.getContext("2d")

    var dt = prev = 0
    var raf
    var dists = []
    var buildings = []
    var monsters = []
    var people = []
    var food = 100
    const D = {
      A_BUILDERS: 'ab',
      A_WARRIORS: 'aw',
      A_GUARDS: 'ag',
      MAX_SPRITES: 100,
      MAX_MONSTERS: 5,
      MAX_BUILDINGS: 15,
      MIN_MONSTER_SIZE: 5,
      PEOPLE_VEL: 50,
      PEOPLE_MOVE_CD: 1,
      PEOPLE_BUILDER_SPAWN_CD: 3,
      PEOPLE_WARRIOR_SPAWN_CD: 2,

      PEOPLE_GUARD_SPAWN_CD: 5,
      P_BD: -1,
      P_WD: 1,
      P_GD: 5,
      B_CD: 1,
      M_CD: 3,
      M_S: 3,
      M_W: 10,
      W_UP: 'u',
      W_DOWN: 'd',
      W_RIGHT: 'r',
      W_LEFT: 'l',
      STOPPED: 's',
    }
    var creating = D.A_BUILDERS;

    function setup() {
      raf = requestAnimationFrame(passo)
      people.push(spawnWalker(150, 150))
      monsters.push(spawnHunter(20, 20))
    }

    function passo(t) {
      dt = (t - prev) / 1000;
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height)

      for (var i = people.length - 1; i >= 0; i--) {
        people[i].behave(dt)
        people[i].move(dt)
        people[i].draw(ctx)
      }
      for (var i = buildings.length - 1; i >= 0; i--) {
        buildings[i].behave(dt)
        buildings[i].move(dt)
        buildings[i].draw(ctx)
      }
      for (var i = monsters.length - 1; i >= 0; i--) {
        monsters[i].behave(dt)
        monsters[i].move(dt)
        monsters[i].draw(ctx)
      }

      for (var j = monsters.length - 1; j >= 0; j--) {
        if(monsters[j].w<D.MIN_MONSTER_SIZE){
          monsters.splice(j,1)
          continue
        }
        for (var i = people.length - 1; i >= 0; i--) {
          if (people[i].isHit(monsters[j])) {
            if (people[i].color === 'green') {
              monsters[j].w -= D.P_WD
              monsters[j].h -= D.P_WD
            } else if (people[i].color === 'blue') {
              monsters[j].w -= D.P_GD
              monsters[j].h -= D.P_GD
            } else {
              monsters[j].w -= D.P_BD
              monsters[j].h -= D.P_BD
              monsters[j].kills++
            }
            people.splice(i, 1)
          }
        }
        for (var i = buildings.length - 1; i >= 0; i--) {
          if (buildings[i].isHit(monsters[j]) &&
            monsters[j].w >= 2 * buildings[i].w) {
            //monsters[j].w -= buildings[i].w
            //monsters[j].h -= buildings[i].w
            buildings.splice(i, 1)
          }
        }
      }
      ctx.fillStyle = 'red'
      ctx.fillText('People: ' + people.length, 20, 10);
      ctx.fillStyle = 'grey'
      ctx.fillText('Buildings: ' + buildings.length, 110, 10);
      ctx.fillStyle = 'purple'
      ctx.fillText('Monsters: ' + monsters.length, 210, 10);
      prev = t;
      switch (creating) {
        case D.A_BUILDERS:
          ctx.fillStyle = 'red'
          ctx.fillText('Builders', 20, 20);
          break;
        case D.A_WARRIORS:
          ctx.fillStyle = 'green'
          ctx.fillText('Warriors', 20, 20);
          break;
        case D.A_GUARDS:
          ctx.fillStyle = 'blue'
          ctx.fillText('Guards', 20, 20);
          break;
      }
      ctx.fillStyle = 'yellow'
      food -= people.length/10*dt
      food = food>0?food:0
      ctx.fillText('Food: ' + Math.ceil(food), 110, 20);

      requestAnimationFrame(passo)
    }

    function Sprite(x = 0, y = 0, w = 5, h = 5, c = 'blue') {
      this.x = x;
      this.y = y;
      this.w = w;
      this.h = h;
      this.vx = 0;
      this.vy = 0;
      this.ax = 0;
      this.ay = 0;
      this.cd = 0;
      this.color = c
      this.status = D.STOPPED
    }


    Sprite.prototype.setStatus = function(status) {
      this.status = status
      switch (status) {
        case D.W_RIGHT:
          this.vx = D.PEOPLE_VEL;
          this.vy = 0;
          break;
        case D.W_LEFT:
          this.vx = -D.PEOPLE_VEL;
          this.vy = 0;
          break;
        case D.W_DOWN:
          this.vx = 0;
          this.vy = D.PEOPLE_VEL;
          break;
        case D.W_UP:
          this.vx = 0;
          this.vy = -D.PEOPLE_VEL;
          this.status = D.W_UP
          break;
        case D.STOPPED:
          this.status = D.STOPPED
        default:
          this.status = D.STOPPED
          this.vx = 0;
          this.vy = 0;
          this.ax = 0;
          this.ay = 0;
      }
    }
    Sprite.prototype.move = function(dt) {
      this.vx += this.ax * dt
      this.x += this.vx * dt
      this.vy += this.ay * dt
      this.y += this.vy * dt

      if (this.x - this.w / 2 < 10) {
        this.x = this.w / 2+10
        this.setStatus(D.W_RIGHT)
      }
      if (this.x + this.w / 2 > canvas.width-10) {
        this.x = canvas.width - this.w / 2 -10
        this.setStatus(D.W_LEFT)
      }
      if (this.y - this.h / 2 < 40) {
        this.y = this.h / 2 + 40
        this.setStatus(D.W_DOWN)
      }
      if (this.y + this.h / 2 > canvas.height-10) {
        this.y = canvas.height - this.h / 2-10
        this.setStatus(D.W_UP)
      }
    }
    Sprite.prototype.draw = function(ctx) {
      ctx.save()
      ctx.translate(this.x, this.y)
      ctx.fillStyle = this.color
      ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h)
      ctx.restore()
    }
    Sprite.prototype.behave = function(dt) {}
    Sprite.prototype.isHit = function(a) {
      if (this.x + this.w / 2 < a.x - a.w / 2) return false
      if (this.x - this.w / 2 > a.x + a.w / 2) return false
      if (this.y + this.h / 2 < a.y - a.h / 2) return false
      if (this.y - this.h / 2 > a.y + a.h / 2) return false
      return true
    };

    function RandomWanderer(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_MOVE_CD
        var dirm = Math.floor(Math.random() * 5)
        switch (dirm) {
          case 0:
            this.setStatus(D.W_RIGHT)
            break;
          case 1:
            this.setStatus(D.W_DOWN)
            break;
          case 2:
            this.setStatus(D.W_LEFT)
            break;
          case 3:
            this.setStatus(D.W_UP)
            break;
          case 4:
            this.setStatus(D.STOPPED)
            this.cd = 2 * D.B_CD
            var spawner = spawnWalkerSpawner(this.x, this.y)
            if (spawner) {
              buildings.push(spawner)
              for (var i = buildings.length - 2; i >= 0; i--) {
                if (buildings[i].isHit(spawner)) {
                  buildings.pop()
                }
              }
            }
            break
        }
      }
    }

    function RandomWarrior(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_MOVE_CD
        if (this.status === D.STOPPED) {
          var dirm = Math.floor(Math.random() * 5)
          switch (dirm) {
            case 0:
              this.setStatus(D.W_RIGHT)
              break;
            case 1:
              this.setStatus(D.W_DOWN)
              break;
            case 2:
              this.setStatus(D.W_LEFT)
              break;
            case 3:
              this.setStatus(D.W_UP)
              break;
            case 4:
              this.setStatus(D.STOPPED)
              this.cd = 2 * D.B_CD
              break
          }
          return
        } else {
          switch (this.status) {
            case D.W_RIGHT:
              this.setStatus(D.W_DOWN)
              break;
            case D.W_DOWN:
              this.setStatus(D.W_LEFT)
              break;
            case D.W_LEFT:
              this.setStatus(D.W_UP)
              break;
            case D.W_UP:
              this.setStatus(D.STOPPED)
              break;
          }
        }
      }
    }

    function RandomGuard(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_MOVE_CD
        var dirm = Math.floor(Math.random() * 10)
        switch (dirm) {
          case 0:
            this.setStatus(D.W_RIGHT)
            break;
          case 1:
            this.setStatus(D.W_DOWN)
            break;
          case 2:
            this.setStatus(D.W_LEFT)
            break;
          case 3:
            this.setStatus(D.W_UP)
            break;
          default:
            this.setStatus(D.STOPPED)
            this.cd = 3 * D.B_CD
            break
        }
      }
    }

    function Hunter(dt) {
      if (monsters.length < D.MAX_MONSTERS && this.kills >= D.M_S) {
        this.kills = 0
        //this.w = this.h = D.M_W
        var hunter = spawnHunter(this.x, this.y)
        if (hunter) monsters.push(hunter)
      }
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.M_CD
        var dirm = Math.floor(Math.random() * 5)
        switch (dirm) {
          case 0:
            this.setStatus(D.W_RIGHT)
            break;
          case 1:
            this.setStatus(D.W_DOWN)
            break;
          case 2:
            this.setStatus(D.W_LEFT)
            break;
          case 3:
            this.setStatus(D.W_UP)
            break;
        }
      }
    }

    function spawnWalker(x, y) {
      if (people.length >= D.MAX_SPRITES) return;
      switch (creating) {
        case D.A_WARRIORS:
          var walker = new Sprite(x, y, 5, 5, 'green')
          walker.behave = RandomWarrior
          walker.cd = D.PEOPLE_WARRIOR_SPAWN_CD
          return walker
          break;
        case D.A_GUARDS:
          var walker = new Sprite(x, y, 5, 5, 'blue')
          walker.behave = RandomGuard
          walker.cd = D.PEOPLE_GUARD_SPAWN_CD
          return walker
          break;
        default:
          var walker = new Sprite(x, y, 5, 5, 'red')
          walker.behave = RandomWanderer
          walker.cd = D.PEOPLE_BUILDER_SPAWN_CD
          return walker

      }

    }

    function spawnWalkerSpawner(x, y) {
      if (buildings.length >= D.MAX_BUILDINGS) return;
      var walker = new Sprite(x, y, 10, 10, 'grey')
      walker.behave = RandomWandererSpawner
      walker.cd = D.B_CD
      return walker
    }

    function spawnHunter(x, y) {
      if (monsters.length >= D.MAX_MONSTERS) return;
      var hunter = new Sprite(x, y, D.M_W, D.M_W, 'purple')
      hunter.behave = Hunter
      hunter.cd = D.M_S
      hunter.kills = 0
      return hunter
    }


    function RandomWandererSpawner(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        switch (creating) {
          case D.A_WARRIORS:
            this.cd = D.PEOPLE_WARRIOR_SPAWN_CD
            break;
          case D.A_GUARDS:
            this.cd = D.PEOPLE_GUARD_SPAWN_CD
            break;
          default:
            this.cd = D.PEOPLE_BUILDER_SPAWN_CD
        }
        var walker = spawnWalker(this.x, this.y)
        if (walker) people.push(walker)
      }
    }



    setup()
    addEventListener('keyup', function(e) {
      switch (e.keyCode) {
        case 65:
          creating = D.A_BUILDERS
          break;
        case 83:
          creating = D.A_WARRIORS
          break;
        case 68:
          creating = D.A_GUARDS
          break;
        default:

      }
    })
  </script>
</body>

</html>
