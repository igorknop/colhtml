<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
</head>

<body>
  <canvas id="canvas" width="300" height="300"></canvas>
  <script type="module">
    import {D} from "./Config.js"
    import {Sprite} from "./Sprite.js"
    import {Builder} from "./Builder.js"
    import {Farmer} from "./Farmer.js"
    import {Warrior} from "./Warrior.js"
    import {Guard} from "./Guard.js"
    import {Monster} from "./Monster.js"
    import {BuildersHall} from "./BuildersHall.js"
    import {World} from "./World.js"
    var canvas = document.getElementsByTagName("canvas")[0]
    var ctx = canvas.getContext("2d")

    var world = new World()
    var dt = 0, prev = 0
    var raf
    var dists = []
    var food = 50
    var foodcd = 0
    var creating = D.A_BUILDERS;

    function setup() {
      raf = requestAnimationFrame(passo)
      world.setup()
    }

    function passo(t) {
      dt = (t - prev) / 1000;
      ctx.fillStyle = "black";
      ctx.fillRect(0, 0, canvas.width, canvas.height)
      world.step(dt, ctx)
      ctx.fillStyle = 'red'
      ctx.fillText('People: ' + world.people.length, 20, 10);
      ctx.fillStyle = 'grey'
      ctx.fillText('Buildings: ' + world.buildings.length, 110, 10);
      ctx.fillStyle = 'purple'
      ctx.fillText('Monsters: ' + world.monsters.length, 210, 10);
      prev = t;
      switch (world.creating) {
        case D.A_FARMERS:
          ctx.fillStyle = 'yellow'
          ctx.fillText('Farmers', 20, 20);
          break;
        case D.A_BUILDERS:
          ctx.fillStyle = 'red'
          ctx.fillText('Builders', 20, 20);
          break;
        case D.A_WARRIORS:
          ctx.fillStyle = 'green'
          ctx.fillText('Warriors', 20, 20);
          break;
        case D.A_GUARDS:
          ctx.fillStyle = 'blue'
          ctx.fillText('Guards', 20, 20);
          break;
      }
      ctx.fillStyle = 'yellow'
      world.food -= world.people.length / 10 * dt
      world.food = world.food > 0 ? world.food : 0
      ctx.fillText('Food: ' + Math.ceil(world.food), 110, 20);

      requestAnimationFrame(passo)
    }



    function RandomWarrior(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_MOVE_CD
        if (this.status === D.STOPPED) {
          var dirm = Math.floor(Math.random() * 5)
          switch (dirm) {
            case 0:
              this.setStatus(D.W_RIGHT)
              break;
            case 1:
              this.setStatus(D.W_DOWN)
              break;
            case 2:
              this.setStatus(D.W_LEFT)
              break;
            case 3:
              this.setStatus(D.W_UP)
              break;
            case 4:
              this.setStatus(D.STOPPED)
              this.cd = 2 * D.B_CD
              break
          }
          return
        } else {
          switch (this.status) {
            case D.W_RIGHT:
              this.setStatus(D.W_DOWN)
              break;
            case D.W_DOWN:
              this.setStatus(D.W_LEFT)
              break;
            case D.W_LEFT:
              this.setStatus(D.W_UP)
              break;
            case D.W_UP:
              this.setStatus(D.STOPPED)
              break;
          }
        }
      }
    }

    function RandomGuard(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_MOVE_CD
        var dirm = Math.floor(Math.random() * 10)
        switch (dirm) {
          case 0:
            this.setStatus(D.W_RIGHT)
            break;
          case 1:
            this.setStatus(D.W_DOWN)
            break;
          case 2:
            this.setStatus(D.W_LEFT)
            break;
          case 3:
            this.setStatus(D.W_UP)
            break;
          default:
            this.setStatus(D.STOPPED)
            this.cd = 3 * D.B_CD
            break
        }
      }
    }

    function Hunter(dt) {
      if (world.monsters.length < D.MAX_MONSTERS && this.kills >= D.M_S) {
        this.kills = 0
        //this.w = this.h = D.M_W
        var hunter = spawnHunter(this.x, this.y)
        if (hunter) world.monsters.push(hunter)
      }
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.M_CD
        var dirm = Math.floor(Math.random() * 5)
        switch (dirm) {
          case 0:
            this.setStatus(D.W_RIGHT)
            break;
          case 1:
            this.setStatus(D.W_DOWN)
            break;
          case 2:
            this.setStatus(D.W_LEFT)
            break;
          case 3:
            this.setStatus(D.W_UP)
            break;
        }
      }
    }

    function spawnWalker(x, y) {
      if (world.people.length >= D.MAX_SPRITES) return;
      switch (creating) {
        case D.A_FARMERS:
          var walker = new Sprite(x, y, 5, 5, 'yellow')
          walker.behave = RandomFarmer
          walker.cd = D.PEOPLE_FARMER_SPAWN_CD
          return walker
          break;
        case D.A_WARRIORS:
          var walker = new Sprite(x, y, 5, 5, 'green')
          walker.behave = RandomWarrior
          walker.cd = D.PEOPLE_WARRIOR_SPAWN_CD
          return walker
          break;
        case D.A_GUARDS:
          var walker = new Sprite(x, y, 5, 5, 'blue')
          walker.behave = RandomGuard
          walker.cd = D.PEOPLE_GUARD_SPAWN_CD
          return walker
          break;
        default:
          var walker = new Builder(world, x, y, 5, 5, 'red')
          walker.cd = D.PEOPLE_BUILDER_SPAWN_CD
          return walker

      }

    }

    function spawnWalkerSpawner(x, y) {
      if (world.buildings.length >= D.MAX_BUILDINGS) return;
      var walker = new Sprite(x, y, 10, 10, 'grey')
      walker.behave = RandomWandererSpawner
      walker.cd = D.B_CD
      return walker
    }

    function spawnFarm(x, y) {
      if (world.buildings.length >= D.MAX_BUILDINGS) return;
      var walker = new Sprite(x, y, 10, 10, 'farm')
      walker.behave = Farm
      walker.cd = D.B_CD
      return walker
    }



    function Farm(dt) {
      if (this.cd > 0) {
        this.cd -= dt
      } else {
        this.cd = D.PEOPLE_FARM_SPAWN_CD
        food += 5 * dt
      }
    }



    setup()
    addEventListener('keyup', function(e) {
      console.log(e.keyCode);
      switch (e.keyCode) {
        case 65:
          world.creating = D.A_BUILDERS
          break;
        case 70:
          world.creating = D.A_FARMERS
          break;
        case 83:
          world.creating = D.A_WARRIORS
          break;
        case 68:
          world.creating = D.A_GUARDS
          break;
        default:

      }
    })
  </script>
</body>

</html>
